<workflow>

	<rule match="$.services[*].units[?(@.state.hostname is None)]">
		<set path="state.hostname">
			<generate-hostname>
				<parameter name="pattern"><select path="::unitNamingPattern"/></parameter>
				<parameter name="service_id"><select path="::id"/></parameter>
			</generate-hostname>
		</set>
	</rule>

	<rule match="$[?(not @.state.deleted)]">
		<rule match="$.services[*].units[*]">
			<empty>
				<delete-cf-stack>
					<success>
						<set path="/state.deleted"><true/></set>
					</success>
				</delete-cf-stack>
			</empty>
		</rule>
	</rule>

</workflow>