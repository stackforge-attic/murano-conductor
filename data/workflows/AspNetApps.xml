<workflow>
	<rule match="$.services.webServers,aspNetApps,webServerFarms,aspNetAppFarms[?(@.domain)].units[*]">
		<set path="domain">
			<select path="::domain"/>
		</set>
	</rule>

	<rule match="$.services.webServers,aspNetApps,webServerFarms,aspNetAppFarms[*].units[?(@.state.hostname and not @.state.instanceName)]">
		<report entity="unit">
			<parameter name="id"><select path="id"/></parameter>
			<parameter name="text">Creating instance <select path="name"/></parameter>
		</report>
		<update-cf-stack template="Windows">
			<parameter name="mappings">
				<map>
					<mapping name="instanceName"><select path="state.hostname"/></mapping>
					<mapping name="userData">
						<prepare-user-data>
							<parameter name="hostname"><select path="state.hostname"/></parameter>
							<parameter name="unit"><select path="id"/></parameter>
							<parameter name="service"><select path="::id"/></parameter>
						</prepare-user-data>
					</mapping>
				</map>
			</parameter>
			<parameter name="arguments">
				<map>
					<argument name="KeyName">murano-keys</argument>
					<argument name="InstanceType">m1.medium</argument>
					<argument name="ImageName">ws-2012-full</argument>
				</map>
			</parameter>

			<success>
				<set path="state.instanceName"><select path="name"/></set>
				<report entity="unit">
					<parameter name="id"><select path="id"/></parameter>
					<parameter name="text">Instance <select path="name"/> created</parameter>
				</report>
			</success>
		</update-cf-stack>
	</rule>

	<rule match="$.services.webServerFarms,aspNetAppFarms[*].units[?(@.state.hostname and not @.state.registeredWithLB)]">
		<update-cf-stack template="LoadBalancer" result="outputs">
			<parameter name="mappings">
				<map>
					<mapping name="instanceName"><select path="state.hostname"/></mapping>
					<mapping name="lbPort"><select path="::loadBalancerPort"/></mapping>
					<mapping name="lbName"><select path="::name"/></mapping>
				</map>
			</parameter>
			<success>
				<set path="state.registeredWithLB"><true/></set>
				<set path="::LoadBalancerIP">
					<select source="outputs" path="LoadBalancerIP"/>
				</set>
			</success>
		</update-cf-stack>
	</rule>

	<rule match="$.services.webServers,aspNetApps,webServerFarms,aspNetAppFarms[?(@.adminPassword and @.adminPassword != @.state.adminPassword)].units[?(@.state.instanceName)]">
		<send-command template="SetPassword">
			<parameter name="unit">
				<select path="id"/>
			</parameter>
			<parameter name="service">
				<select path="::id"/>
			</parameter>
			<parameter name="mappings">
				<map>
					<mapping name="adminPassword">
						<select path="::adminPassword"/>
					</mapping>
				</map>
			</parameter>
			<success>
				<set path="::state.adminPassword">
					<select path="::adminPassword"/>
				</set>
			</success>
		</send-command>
	</rule>


	<rule match="$.services.webServers,aspNetApps,webServerFarms,aspNetAppFarms[*].units[?(@.state.instanceName and not @.state.iisInstalled)]">
		<report entity="unit">
			<parameter name="id"><select path="id"/></parameter>
			<parameter name="text">Creating IIS Web Server on unit <select path="name"/></parameter>
		</report>
		<send-command template="InstallIIS">
			<parameter name="unit">
				<select path="id"/>
			</parameter>
			<parameter name="service">
				<select path="::id"/>
			</parameter>
			<success>
				<set path="state.iisInstalled"><true/></set>
				<report entity="unit">
					<parameter name="id"><select path="id"/></parameter>
					<parameter name="text">IIS <select path="name"/> has started</parameter>
				</report>
			</success>
		</send-command>
	</rule>

	<rule match="$.services.aspNetApps,aspNetAppFarms[*].units[?(@.state.iisInstalled and not @.state.webAppDeployed)]">
		<report entity="unit">
			<parameter name="id"><select path="id"/></parameter>
			<parameter name="text">Deploying Web App on unit <select path="name"/></parameter>
		</report>
		<send-command template="DeployWebApp">
			<parameter name="unit">
				<select path="id"/>
			</parameter>
			<parameter name="service">
				<select path="::id"/>
			</parameter>
            <parameter name="mappings">
				<map>
					<mapping name="repository">
						<select path="::repository"/>
					</mapping>
				</map>
			</parameter>
			<success>
				<set path="state.webAppDeployed"><true/></set>
				<report entity="unit">
					<parameter name="id"><select path="id"/></parameter>
					<parameter name="text">WebApp <select path="name"/> has been deployed.</parameter>
				</report>
			</success>
		</send-command>
	</rule>

</workflow>